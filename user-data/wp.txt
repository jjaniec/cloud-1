#!/bin/bash -xe
exec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1
  curl https://s3.amazonaws.com//aws-cloudwatch/downloads/latest/awslogs-agent-setup.py -O
  chmod +x ./awslogs-agent-setup.py
  sed -i  's/\\S/Amazon Linux AMI\\S/g' /etc/issue

  sudo ./awslogs-agent-setup.py -n -r '${ current_region }' -c 's3://${ awslogs_conf_bucket }/${ awslogs_conf_key }'
  sudo yum update -y
  sudo amazon-linux-extras install -y docker
  sudo service docker start
  sudo usermod -a -G docker ec2-user
  sudo docker run \
   -d \
   -p 80:80 \
   -e WORDPRESS_DB_HOST="${ db_host }" \
   -e WORDPRESS_DB_USER="${ db_user }" \
   -e WORDPRESS_DB_PASSWORD="${ db_password }" \
   -e WORDPRESS_DB_NAME="${ db_name }" \
   --name wordpress \
   wordpress
  sudo docker exec wordpress curl -O 'https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar'
  sudo docker exec wordpress chmod +x wp-cli.phar
  sudo docker exec wordpress mv wp-cli.phar /usr/local/bin/wp
  sudo docker exec wordpress wp plugin install --allow-root amazon-s3-and-cloudfront
  sudo docker exec wordpress wp plugin activate --allow-root amazon-s3-and-cloudfront
  ${ wp_plugin_configs }
  sudo docker logs -f wordpress | tee /var/log/wordpress.log
